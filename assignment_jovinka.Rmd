---
title: "Vast Mini Challenge 2 - Answer"
author: "Jovinka Hartanto"
date: "7/13/2021"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, 
                      eval = TRUE,
                      message = FALSE,
                      warning = FALSE,
                      fig.retina = 3)
```

```{r install packages and load library, include=FALSE}
packages = c('raster', 'sf', 'st',
             'tmap','mapview', 'clock', 
             'tidyverse','plotly','lubridate', 'ggiraph', 'plotly', 
             'DT', 'patchwork',
             'tidyverse','ggplot2','data.table')
for (p in packages){
  if(!require(p, character.only = T)){
    install.packages(p)
  }
  library(p,character.only = T)
}

```

## Question 1

By observing loyalty and credit card data, we can observe that the top three most visited places during the 2 weeks data are:

1. Katerina's Cafe
Employee usually go to Katerina's Cafe on <day> between <hours> 

2. Hippokampos
Employee usually go to Hippokampos on <day> between <hours> 

3. Guy's Gyros
Employee usually go to Guy's Gyros Cafe on <day> between <hours> 

##Anomalies

1. Mismatch between credit card and loyalty card transactions

As we can see in the figure below, the number of daily frequency from credit card data and loyalty data are different. Based on credit card data the Katerina's Cafe is most visited in 2014-06-01 with total of ... transactions. However, if we observed loyalty data Katerina's Cafe is most visited in ... with total of ... transactions. This problem also happened to other shops or location that we are observing. 

There are total of ... un-matched records. These un-matched records might lead to some new clues. 

2. Wrong time in credit card transaction data
Bean There Done That
Brewed Awakenings
Jack's Magical Beans

To correct this anomaly, we can add vehicle data to our analysis, we might be able to determine some of the transactions based on the employee location. 


```{r import cc data and loyalty card data, include=FALSE}
loyalty_data <- read_csv("MC2/loyalty_data.csv")

loyalty_data$timestamp <- date_time_parse(loyalty_data$timestamp,
                                zone = "",
                                format = "%m/%d/%Y")
for(i in 1:nrow(loyalty_data))
{
  if(loyalty_data$location[i] %like% "Katerina") 
  {
  loyalty_data$location[i] <- str_replace(loyalty_data$location[i],loyalty_data$location[i],"Katerina's Cafe") 
  }
}

cc_data <- read_csv("MC2/cc_data.csv")

cc_data$timestamp_date <- date_time_parse(cc_data$timestamp,
                                zone = "",
                                format = "%m/%d/%Y")
cc_data$timestamp <- date_time_parse(cc_data$timestamp,
                                zone = "",
                                format = "%m/%d/%Y %H:%M")
cc_data$time = format(cc_data$timestamp, format = "%H:%M")
cc_data$hours = get_hour(cc_data$timestamp)
cc_data$day = weekdays(cc_data$timestamp)

for(i in 1:nrow(cc_data))
{
  if(cc_data$location[i] %like% "Katerina") 
  {
   cc_data$location[i] <- str_replace(cc_data$location[i],cc_data$location[i],"Katerina's Cafe") 
  }
}

```

```{r cc freq and cc loyalty}
cc_freq <- group_by(cc_data, location) %>% summarise(freq = n())%>% arrange(desc(freq))
cc_freq

loyalty_freq <- group_by(loyalty_data, location) %>% summarise(freq = n())%>% arrange(desc(freq))
loyalty_freq

```

```{r cc and loyalty daytime, figures-side, fig.show="hold", out.width="50%"}

cc_freq_2 <- group_by(cc_data, location, day, hours) %>% summarise(freq = n())%>% arrange(desc(freq))
cc_freq_selected_1 <- cc_freq_2 %>% filter(location == "Katerina's Cafe") %>% arrange(day)
cc_freq_selected_2 <- cc_freq_2 %>% filter(location == "Guy's Gyros") %>% arrange(day)
cc_freq_selected_3 <- cc_freq_2 %>% filter(location == "Hippokampos") %>% arrange(day)

int_plot_cc <- function(cc_freq_selected)
{cc_freq_selected%>%
  plot_ly(
    type = 'bar',
    x = ~hours,
    y = ~freq,
    text = ~day,
    hoverinfo = 'text',
    mode = 'markers',
    colors = 'blue',
    transforms = list(
      list(
        type = 'filter',
        target = ~day,
        operation = '=',
        value = unique(cc_freq_selected$day)[1]
      )
  )) %>% layout(
    updatemenus = list(
      list(
        type = 'dropdown',
        active = 0,
        buttons = list(
          list(method = "restyle",
               args = list("transforms[0].value", unique(cc_freq_selected$day)[2]),
               label = unique(cc_freq_selected$day)[2]),
          list(method = "restyle",
               args = list("transforms[0].value", unique(cc_freq_selected$day)[6]),
               label = unique(cc_freq_selected$day)[6]),
          list(method = "restyle",
               args = list("transforms[0].value", unique(cc_freq_selected$day)[7]),
               label = unique(cc_freq_selected$day)[7]),
          list(method = "restyle",
               args = list("transforms[0].value", unique(cc_freq_selected$day)[5]),
               label = unique(cc_freq_selected$day)[5]),
          list(method = "restyle",
               args = list("transforms[0].value", unique(cc_freq_selected$day)[1]),
               label = unique(cc_freq_selected$day)[1]),
          list(method = "restyle",
               args = list("transforms[0].value", unique(cc_freq_selected$day)[3]),
               label = unique(cc_freq_selected$day)[3]),
          list(method = "restyle",
               args = list("transforms[0].value", unique(cc_freq_selected$day)[4]),
               label = unique(cc_freq_selected$day)[4])
        )
      )
    )
  ) %>% layout(title = unique(cc_freq_selected$location), barmode = 'group')
}


int_plot_cc(cc_freq_selected_1)
int_plot_cc(cc_freq_selected_2)
int_plot_cc(cc_freq_selected_3)




```

``` {r loyalty and  cc top 3 daily frequency, figures-side, fig.show="hold", out.width="100%"}


cc_freq_daily <- group_by(cc_data, timestamp_date, location) %>% summarise(freq = n())%>% arrange(desc(freq))
top3_place = c("Katerina's Cafe", "Hippokampos","Guy's Gyros")

cc_freq_daily_selected <- cc_freq_daily %>% filter(location %in% top3_place)

top3_vis_cc <- ggplot(cc_freq_daily_selected, aes(fill=as.character(timestamp_date), y=freq, x=location)) + 
    geom_bar(position="stack", stat="identity") +
    geom_text(label = cc_freq_daily_selected$freq, position=position_stack(vjust=0.5))+
    ggtitle("CC data top 3 location")

ggplotly(top3_vis_cc)

loyalty_freq_daily <- group_by(loyalty_data, timestamp, location) %>% summarise(freq = n())%>% arrange(desc(freq))
top3_place = c("Katerina's Cafe", "Hippokampos","Guy's Gyros")

loyalty_freq_daily_selected <- loyalty_freq_daily %>% filter(location %in% top3_place)

top3_vis_L <- ggplot(loyalty_freq_daily_selected, aes(fill=as.character(timestamp), y=freq, x=location)) + 
    geom_bar(position="stack", stat="identity") +
    geom_text(label = loyalty_freq_daily_selected$freq, position=position_stack(vjust=0.5))+
    ggtitle("Loyalty data top 3 location")

ggplotly(top3_vis_L)

```

```{r}


```

```{r}

```


##Question 2

```{r gps time duration}
gps_data <- read_csv("MC2/gps.csv")

gps_data$Timestamp_date <- date_time_parse(gps_data$Timestamp,
                                zone = "",
                                format = "%m/%d/%Y")

gps_data$Timestamp <- date_time_parse(gps_data$Timestamp,
                                zone = "",
                                format = "%m/%d/%Y %H:%M")
gps_data$Time <- format(gps_data$Timestamp, format = "%H:%M")
gps_data$Hour <- get_hour(gps_data$Timestamp)


gps_sort <- gps_data[order(gps_data$Timestamp, gps_data$id),]

stop_fin_2 = data.frame()

for (id_1 in unique(gps_sort$id))
{
  make_stop = data.frame()
  gps_id <- gps_sort %>%
  filter(id==id_1)
  
  for(i in 1:nrow(gps_id))
  {
    if(i < nrow(gps_id))
    {
      start <- gps_id$Timestamp[i]
      end <- gps_id$Timestamp[i+1]
    } else
    {
      start <- gps_id$Timestamp[i]
      end <- gps_id$Timestamp[i]
      print(start)
    }
    elapsed.time <- start%--%end
    time_duration <- as.duration(elapsed.time)
    
    if(time_duration > 300)
    {
      make_stop = rbind(make_stop,cbind(gps_id[i,],time_duration,i),cbind(gps_id[i+1,],time_duration,i))
    }
    
  }
  
  stop_fin_2 = rbind(stop_fin_2, make_stop)
}
```
```{r}
elapsed.time
```


```{r location point}

location_point = read_csv("MC2/stop_fin.csv") %>% select(lat,long,Possible_Location)%>% unique()
stop_fin_2$lat = round(stop_fin_2$lat,5)
stop_fin_2$long = round(stop_fin_2$long,5)

stop_final = merge(stop_fin_2,location_point, by.x = c("lat","long"), by.y = c("lat","long"), all.x = TRUE)

stop_fin <- stop_final


stop_fin_location <- stop_fin[!(stop_fin$Possible_Location %like% 'mice'),]

gps_sf_stopfin <- st_as_sf(stop_fin_location,
                   coords = c("long","lat"),
                   crs=4326)

```

```{r}

gps_sf_stopfin_unique1 <- gps_sf_stopfin  %>% select(Possible_Location,geometry)%>%unique()%>%arrange(Possible_Location)

gps_sf_stopfin_unique <- gps_sf_stopfin_unique1[-c(221,476,644,1100,1103),]

gps_path_stopfin <- gps_sf_stopfin_unique %>%
  group_by(Possible_Location) %>%
  summarize(m_Timestamp = mean(geometry),
            do_union = FALSE ) %>%
  st_cast("LINESTRING")


Abila_st <- st_read(dsn = "MC2/Geospatial",
                    layer = "Abila")

P <- npts(Abila_st, by_feature = TRUE)
abila_st_2 <- cbind(Abila_st,P) %>% filter(P > 1)
bgmap <- raster("MC2/Geospatial/MC2-tourist.TIF")

tmap_mode("view")
tm_shape(bgmap) +
  tm_rgb(bgmap, r = 1, g = 2, b = 3,
         alpha = NA,
         saturation = 1,
         interpolate = TRUE,
         max.value = 255) +
  tm_shape(abila_st_2) +
  tm_lines(col = "red", scale = 1)+
  tm_shape(gps_path_stopfin[9,]) +
  tm_lines(col = "blue", scale =4, interactive = TRUE) +
  tm_text("Possible_Location", size = 3, remove.overlap = TRUE, overwrite.lines = TRUE, just = "top")

```


```{r}
gps_data <- read_csv("MC2/gps.csv")

gps_data$Timestamp_date <- date_time_parse(gps_data$Timestamp,
                                zone = "",
                                format = "%m/%d/%Y")

gps_data$Timestamp <- date_time_parse(gps_data$Timestamp,
                                zone = "",
                                format = "%m/%d/%Y %H:%M")
gps_data$Time <- format(gps_data$Timestamp, format = "%H:%M")
gps_data$Hour <- get_hour(gps_data$Timestamp)


gps_sf <- st_as_sf(gps_data,
                   coords = c("long","lat"),
                   crs=4326)

gps_path <- gps_sf %>%
  group_by(id, Timestamp_date,Hour) %>%
  summarize(m_Timestamp = mean(Timestamp_date),
            do_union = FALSE ) %>%
  st_cast("LINESTRING")


Abila_st <- st_read(dsn = "MC2/Geospatial",
                    layer = "Abila")
P <- npts(Abila_st, by_feature = TRUE)
abila_st_2 <- cbind(Abila_st,P) %>% filter(P > 1)


```

```{r}


```


```{r}

gps_path_selected <- gps_path %>%
  filter(id==28)


bgmap <- raster("MC2/Geospatial/MC2-tourist.TIF")

tmap_mode("view")
tm_shape(bgmap) +
  tm_rgb(bgmap, r = 1, g = 2, b = 3,
         alpha = NA,
         saturation = 1,
         interpolate = TRUE,
         max.value = 255) +
  tm_shape(abila_st_2) +
  tm_lines(col = "red", scale = 1)+
  tm_shape(gps_path_selected[1:4,]) +
  tm_lines(col = "black", scale =4, interactive = TRUE) +
  tm_text("Hour", size = 3, remove.overlap = TRUE, overwrite.lines = TRUE, just = "top")



```

```{r}
library(plotly)    

p <- iris %>%
  plot_ly(
    type = 'scatter', 
    x = ~Sepal.Length, 
    y = ~Petal.Length,
    text = ~Species,
    hoverinfo = 'text',
    mode = 'markers', 
    transforms = list(
      list(
        type = 'filter',
        target = ~Species,
        operation = '=',
        value = unique(iris$Species)[1]
      )
  )) %>% layout(
    updatemenus = list(
      list(
        type = 'dropdown',
        active = 0,
        buttons = list(
          list(method = "restyle",
               args = list("transforms[0].value", unique(iris$Species)[1]),
               label = unique(iris$Species)[1]),
          list(method = "restyle",
               args = list("transforms[0].value", unique(iris$Species)[2]),
               label = unique(iris$Species)[2]),
          list(method = "restyle",
               args = list("transforms[0].value", unique(iris$Species)[3]),
               label = unique(iris$Species)[3])
        )
      )
    )
  )

p
```